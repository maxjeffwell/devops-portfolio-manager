name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application to rollback'
        required: true
        type: choice
        options:
          - intervalai
          - bookmarked
          - firebook
          - educationelly
          - educationelly-graphql
          - code-talk
      revision:
        description: 'Revision number to rollback to (0 for previous)'
        required: false
        default: '0'
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: false
        default: 'default'
        type: string

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.application }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Configure kubectl
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Check current release
        id: current-release
        run: |
          APP="${{ github.event.inputs.application }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          echo "Current release history for ${APP}:"
          helm history ${APP} -n ${NAMESPACE}

          CURRENT_REVISION=$(helm history ${APP} -n ${NAMESPACE} --max 1 -o json | jq -r '.[0].revision')
          echo "current-revision=${CURRENT_REVISION}" >> $GITHUB_OUTPUT

      - name: Confirm rollback
        run: |
          APP="${{ github.event.inputs.application }}"
          REVISION="${{ github.event.inputs.revision }}"
          CURRENT="${{ steps.current-release.outputs.current-revision }}"

          if [ "${REVISION}" == "0" ]; then
            TARGET_REVISION=$((CURRENT - 1))
          else
            TARGET_REVISION="${REVISION}"
          fi

          echo "⚠️ Preparing to rollback ${APP}"
          echo "Current revision: ${CURRENT}"
          echo "Target revision: ${TARGET_REVISION}"
          echo ""
          echo "This will rollback the application to a previous state."

      - name: Perform rollback
        run: |
          APP="${{ github.event.inputs.application }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"
          REVISION="${{ github.event.inputs.revision }}"

          echo "Rolling back ${APP}..."

          if [ "${REVISION}" == "0" ]; then
            # Rollback to previous revision
            helm rollback ${APP} -n ${NAMESPACE} --wait --timeout 5m
          else
            # Rollback to specific revision
            helm rollback ${APP} ${REVISION} -n ${NAMESPACE} --wait --timeout 5m
          fi

      - name: Verify rollback
        run: |
          APP="${{ github.event.inputs.application }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          echo "Verifying rollback..."
          kubectl wait --for=condition=ready pod \
            -l app=${APP}-server \
            -n ${NAMESPACE} \
            --timeout=300s || true

          echo "Rollback completed!"
          echo "New release status:"
          helm status ${APP} -n ${NAMESPACE}

          echo ""
          echo "Updated pods:"
          kubectl get pods -n ${NAMESPACE} -l app=${APP}-server

      - name: Run post-rollback tests
        run: |
          APP="${{ github.event.inputs.application }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          echo "Running post-rollback health checks..."

          # Get the first pod
          POD=$(kubectl get pods -n ${NAMESPACE} -l app=${APP}-server -o jsonpath='{.items[0].metadata.name}')

          if [ -n "${POD}" ]; then
            echo "Testing pod: ${POD}"
            kubectl exec -n ${NAMESPACE} ${POD} -- curl -f http://localhost:8080/api || echo "Warning: Health check failed"
          fi

      - name: Rollback summary
        if: always()
        run: |
          APP="${{ github.event.inputs.application }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          echo "==================================="
          echo "Rollback Summary"
          echo "==================================="
          echo "Application: ${APP}"
          echo "Namespace: ${NAMESPACE}"
          echo "Status: ${{ job.status }}"
          echo ""
          echo "Current release history:"
          helm history ${APP} -n ${NAMESPACE} --max 5
