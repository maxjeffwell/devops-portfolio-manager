# Default values for IntervalAI
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 2

image:
  server:
    repository: maxjeffwell/spaced-repetition-capstone-server
    tag: 20251203-113640-b9f0d3d
    pullPolicy: Always
  client:
    repository: maxjeffwell/spaced-repetition-capstone-client
    tag: 20251203-113640-b9f0d3d
    pullPolicy: Always

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

podSecurityContext:
  fsGroup: 2000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1001

# Client-specific security context (nginx needs to bind to port 80)
securityContextClient:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false

service:
  server:
    type: ClusterIP
    port: 8080
    targetPort: 8080
    nodePort: 30786
  client:
    type: NodePort
    port: 80
    targetPort: 8080
    nodePort: 30787

ingress:
  enabled: false
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: intervalai.el-jefe.me
      paths:
        - path: /api
          pathType: Prefix
          backend:
            service:
              name: intervalai-server
              port: 8080
        - path: /
          pathType: Prefix
          backend:
            service:
              name: intervalai-client
              port: 80
  tls:
    - secretName: intervalai-tls
      hosts:
        - intervalai.el-jefe.me

resources:
  server:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  client:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

# MongoDB configuration
mongodb:
  enabled: true
  auth:
    enabled: true
    rootPassword: "intervalai-root-password"
    username: "intervalai"
    password: "intervalai-password"
    database: "intervalai"
  persistence:
    enabled: true
    size: 8Gi
    storageClass: ""
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  # Connection Pool Configuration
  # These settings prevent connection exhaustion under load
  pool:
    # Minimum number of connections to maintain
    minSize: 10
    # Maximum number of connections allowed (higher for ML workloads)
    maxSize: 100
    # Time (ms) before idle connections are closed
    maxIdleTimeMs: 30000
    # Timeout (ms) for waiting for available connection
    waitQueueTimeoutMs: 5000
    # Timeout (ms) for server selection
    serverSelectionTimeoutMs: 5000

# Environment variables
env:
  server:
    - name: NODE_ENV
      value: "production"
    - name: PORT
      value: "8080"
    - name: MONGODB_URI
      valueFrom:
        secretKeyRef:
          name: intervalai-secret
          key: MONGODB_URI
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: intervalai-secret
          key: JWT_SECRET
    # MongoDB Connection Pool Configuration
    - name: MONGODB_POOL_MIN_SIZE
      value: "10"
    - name: MONGODB_POOL_MAX_SIZE
      value: "100"
    - name: MONGODB_MAX_IDLE_TIME_MS
      value: "30000"
    - name: MONGODB_WAIT_QUEUE_TIMEOUT_MS
      value: "5000"
    - name: MONGODB_SERVER_SELECTION_TIMEOUT_MS
      value: "5000"
  client:
    - name: REACT_APP_API_URL
      value: "http://intervalai-server:8080"

# Health check configuration
livenessProbe:
  tcpSocket:
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# ConfigMap data
configMap:
  data:
    ML_MODEL_PATH: "/app/ml/saved-model"
    LOG_LEVEL: "info"
    CACHE_ENABLED: "true"

# Secret data (base64 encoded)
# Note: In production, use external secret management
secret:
  data:
    MONGODB_URI: "bW9uZ29kYitzcnY6Ly9tYXhqZWZmd2VsbDI6ODhaSUFodHAzQHNwYWNlZC1yZXBldGl0aW9uLmp1djh3dmYubW9uZ29kYi5uZXQvc3BhY2VkLXJlcGV0aXRpb24/YXBwTmFtZT1zcGFjZWQtcmVwZXRpdGlvbg=="
    JWT_SECRET: "eW91ci1qd3Qtc2VjcmV0LWtleQ=="

# Monitoring
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
