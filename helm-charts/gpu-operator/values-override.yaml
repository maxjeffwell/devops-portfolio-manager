# GPU Operator Helm values override
# Keeps operator + NFD master on the control-plane node (vmi2951245) so leader
# election lease renewals use loopback to the local API server, avoiding the
# cross-node network timeouts that cause CrashLoopBackOff.
#
# Managed by ArgoCD (gitops/applications/gpu-operator.yaml).
# After manual sync, re-run patch-operator-probes.sh to fix hardcoded operator probes.

# Preserve existing user values
driver:
  enabled: false
migManager:
  enabled: false
toolkit:
  enabled: true
devicePlugin:
  enabled: true
dcgmExporter:
  enabled: true
nodeStatusExporter:
  enabled: true

# Operator controller - no node affinity override (defaults to control-plane
# via chart's built-in preferredDuringScheduling for control-plane/master nodes)
operator:
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 128Mi

node-feature-discovery:
  # Bump to v0.18.3 (latest patch)
  image:
    repository: registry.k8s.io/nfd/node-feature-discovery
    tag: v0.18.3
  # NFD master - no node affinity override (defaults to control-plane via
  # chart's built-in toleration for control-plane/master nodes)
  master:
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
      periodSeconds: 20
      failureThreshold: 5
    readinessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 10
    resources:
      limits:
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 128Mi
  # NFD worker - fix aggressive probe timeouts causing 383+ restarts on control-plane node
  # Default: timeoutSeconds=1, failureThreshold=3 (liveness)
  # With control-plane CPU contention, /healthz regularly times out within 1s
  worker:
    livenessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 5
    readinessProbe:
      initialDelaySeconds: 5
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 10
  gc:
    livenessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
    readinessProbe:
      initialDelaySeconds: 5
      timeoutSeconds: 5
