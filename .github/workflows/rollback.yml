name: Rollback Deployment (GitOps)

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application to rollback'
        required: true
        type: choice
        options:
          - intervalai
          - bookmarked
          - firebook
          - educationelly
          - educationelly-graphql
          - code-talk
          - podrick
      commits-back:
        description: 'Number of commits back to rollback (1 = previous version)'
        required: false
        default: '1'
        type: string

permissions:
  contents: write

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.application }}
    runs-on: ubuntu-latest
    concurrency:
      group: gitops-rollback-${{ github.event.inputs.application }}
      cancel-in-progress: false
    env:
      APP: ${{ github.event.inputs.application }}
      COMMITS_BACK: ${{ github.event.inputs.commits-back }}
      TRIGGERED_BY: ${{ github.actor }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine file paths
        id: paths
        run: |
          if [ "${APP}" == "podrick" ]; then
            # Podrick uses k8s/deployments/ with two files
            echo "is_podrick=true" >> $GITHUB_OUTPUT
            echo "api_file=k8s/deployments/api-deployment.yaml" >> $GITHUB_OUTPUT
            echo "dashboard_file=k8s/deployments/dashboard-deployment.yaml" >> $GITHUB_OUTPUT
          else
            # All other apps use helm-charts/
            echo "is_podrick=false" >> $GITHUB_OUTPUT
            echo "values_file=helm-charts/${APP}/values.yaml" >> $GITHUB_OUTPUT
          fi

      - name: Find previous image tag (Helm apps)
        id: find-tag-helm
        if: steps.paths.outputs.is_podrick == 'false'
        env:
          VALUES_FILE: ${{ steps.paths.outputs.values_file }}
        run: |
          echo "Looking for previous image tags in ${VALUES_FILE}..."

          # Get current tag
          CURRENT_TAG=$(grep -E "^\s+tag:" "${VALUES_FILE}" | head -1 | awk '{print $2}')
          echo "Current tag: ${CURRENT_TAG}"

          # Find the commit that changed the tag N commits ago
          PREVIOUS_TAG=$(git log -p --follow -S "tag:" -- "${VALUES_FILE}" | \
            grep -E "^\+\s+tag:" | \
            head -n $((COMMITS_BACK + 1)) | \
            tail -1 | \
            awk '{print $2}')

          if [ -z "${PREVIOUS_TAG}" ] || [ "${PREVIOUS_TAG}" == "${CURRENT_TAG}" ]; then
            # Fallback: get from git show
            COMMIT_HASH=$(git log --oneline -- "${VALUES_FILE}" | sed -n "$((COMMITS_BACK + 1))p" | awk '{print $1}')
            if [ -n "${COMMIT_HASH}" ]; then
              PREVIOUS_TAG=$(git show "${COMMIT_HASH}:${VALUES_FILE}" 2>/dev/null | grep -E "^\s+tag:" | head -1 | awk '{print $2}')
            fi
          fi

          if [ -z "${PREVIOUS_TAG}" ]; then
            echo "âŒ Could not find previous image tag"
            exit 1
          fi

          echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          echo "current-tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“‹ Rollback plan:"
          echo "   Current: ${CURRENT_TAG}"
          echo "   Target:  ${PREVIOUS_TAG}"

      - name: Find previous image tag (Podrick)
        id: find-tag-podrick
        if: steps.paths.outputs.is_podrick == 'true'
        env:
          API_FILE: ${{ steps.paths.outputs.api_file }}
        run: |
          echo "Looking for previous image tags in Podrick deployments..."

          # Get current tag from API deployment
          CURRENT_TAG=$(grep -E "image:.*devops-portfolio-api:" "${API_FILE}" | sed 's/.*://' | tr -d ' ')
          echo "Current tag: ${CURRENT_TAG}"

          # Find the commit that changed the image N commits ago
          COMMIT_HASH=$(git log --oneline -- "${API_FILE}" | sed -n "$((COMMITS_BACK + 1))p" | awk '{print $1}')

          if [ -n "${COMMIT_HASH}" ]; then
            PREVIOUS_TAG=$(git show "${COMMIT_HASH}:${API_FILE}" 2>/dev/null | grep -E "image:.*devops-portfolio-api:" | sed 's/.*://' | tr -d ' ')
          fi

          if [ -z "${PREVIOUS_TAG}" ]; then
            echo "âŒ Could not find previous image tag"
            exit 1
          fi

          echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          echo "current-tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“‹ Rollback plan:"
          echo "   Current: ${CURRENT_TAG}"
          echo "   Target:  ${PREVIOUS_TAG}"

      - name: Set rollback tags
        id: tags
        run: |
          if [ "${APP}" == "podrick" ]; then
            echo "previous-tag=${{ steps.find-tag-podrick.outputs.previous-tag }}" >> $GITHUB_OUTPUT
            echo "current-tag=${{ steps.find-tag-podrick.outputs.current-tag }}" >> $GITHUB_OUTPUT
          else
            echo "previous-tag=${{ steps.find-tag-helm.outputs.previous-tag }}" >> $GITHUB_OUTPUT
            echo "current-tag=${{ steps.find-tag-helm.outputs.current-tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Rollback with retry
        env:
          PREVIOUS_TAG: ${{ steps.tags.outputs.previous-tag }}
          CURRENT_TAG: ${{ steps.tags.outputs.current-tag }}
          IS_PODRICK: ${{ steps.paths.outputs.is_podrick }}
          VALUES_FILE: ${{ steps.paths.outputs.values_file }}
          API_FILE: ${{ steps.paths.outputs.api_file }}
          DASHBOARD_FILE: ${{ steps.paths.outputs.dashboard_file }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            git fetch origin main
            git reset --hard origin/main

            if [ "${IS_PODRICK}" == "true" ]; then
              # Update Podrick deployment files
              sed -i "s|image: ghcr.io/maxjeffwell/devops-portfolio-api:.*|image: ghcr.io/maxjeffwell/devops-portfolio-api:${PREVIOUS_TAG}|" "${API_FILE}"
              sed -i "s|image: ghcr.io/maxjeffwell/devops-portfolio-dashboard:.*|image: ghcr.io/maxjeffwell/devops-portfolio-dashboard:${PREVIOUS_TAG}|" "${DASHBOARD_FILE}"

              git add "${API_FILE}" "${DASHBOARD_FILE}"
            else
              # Update Helm values.yaml
              sed -i "s|tag: .*|tag: ${PREVIOUS_TAG}|g" "${VALUES_FILE}"

              git add "${VALUES_FILE}"
            fi

            if git diff --staged --quiet; then
              echo "No changes to commit - already at target version"
              exit 0
            fi

            git commit -m "Rollback ${APP} from ${CURRENT_TAG} to ${PREVIOUS_TAG}

          Triggered by: ${TRIGGERED_BY}
          Reason: Manual rollback via GitHub Actions"

            if git push origin main; then
              echo ""
              echo "âœ… GitOps rollback committed!"
              echo "ArgoCD will automatically sync the rollback."
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Push failed (attempt $RETRY_COUNT/$MAX_RETRIES), retrying..."
            sleep $((RETRY_COUNT * 2))
          done

          echo "Failed to push after $MAX_RETRIES attempts"
          exit 1

      - name: Rollback summary
        if: always()
        env:
          CURRENT_TAG: ${{ steps.tags.outputs.current-tag }}
          PREVIOUS_TAG: ${{ steps.tags.outputs.previous-tag }}
        run: |
          echo "==================================="
          echo "GitOps Rollback Summary"
          echo "==================================="
          echo "Application: ${APP}"
          echo "Previous tag: ${CURRENT_TAG}"
          echo "Rolled back to: ${PREVIOUS_TAG}"
          echo "Status: ${{ job.status }}"
          echo ""
          echo "ArgoCD will detect the change and sync automatically."
          echo "Monitor at: https://argocd.el-jefe.me"
