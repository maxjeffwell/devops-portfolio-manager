apiVersion: batch/v1
kind: CronJob
metadata:
  name: dns-zone-restore-test
  labels:
    app: dns-zone-restore-test
spec:
  schedule: "0 7 1-7 * 0"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 172800
      template:
        metadata:
          labels:
            app: dns-zone-restore-test
            portfolio: "true"
        spec:
          restartPolicy: Never
          containers:
          - name: restore-test
            image: alpine:3.21
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache curl jq aws-cli > /dev/null 2>&1

              echo "=== DNS Zone Restore Test ==="
              echo "Date: $(date)"
              PASS=0
              FAIL=0

              # Find latest DNS backup in B2
              LATEST=$(aws s3 ls "s3://${B2_BUCKET}/dns-backups/" \
                --endpoint-url="${B2_ENDPOINT}" | grep "dns-zone-" | sort | tail -1 | awk '{print $NF}')

              if [ -z "$LATEST" ]; then
                echo "ERROR: No DNS zone backup found in B2!"
                echo "=== Summary: 0 passed, 1 failed ==="
                exit 1
              fi

              echo "Found: ${LATEST}"

              # Check backup age (weekly backups should be < 8 days old)
              FILE_DATE=$(echo "$LATEST" | grep -oE '[0-9]{8}' | head -1)
              FILE_DATE_FMT=$(echo "$FILE_DATE" | sed 's/\(.\{4\}\)\(.\{2\}\)/\1-\2-/')
              TODAY_FMT=$(date +%Y-%m-%d)
              AGE_DAYS=$(( ($(date -d "$TODAY_FMT" +%s) - $(date -d "$FILE_DATE_FMT" +%s)) / 86400 ))
              echo "Backup age: ${AGE_DAYS} days"

              if [ "$AGE_DAYS" -gt 8 ]; then
                echo "FAIL: Backup is ${AGE_DAYS} days old (expected <8 for weekly schedule)"
                FAIL=$((FAIL + 1))
              else
                echo "Age check: OK"
                PASS=$((PASS + 1))
              fi

              # Download
              aws s3 cp "s3://${B2_BUCKET}/dns-backups/${LATEST}" "/tmp/${LATEST}" \
                --endpoint-url="${B2_ENDPOINT}" > /dev/null

              SIZE=$(du -h "/tmp/${LATEST}" | cut -f1)
              echo "Downloaded: ${SIZE}"

              # Extract tarball
              mkdir -p /tmp/dns-extract
              if tar xzf "/tmp/${LATEST}" -C /tmp/dns-extract; then
                echo "Extract: OK"
              else
                echo "FAIL: Could not extract tarball!"
                FAIL=$((FAIL + 1))
                echo ""
                echo "=== Summary: ${PASS} passed, ${FAIL} failed ==="
                exit 1
              fi

              # Validate all_records.json
              echo ""
              echo "--- Validating DNS records ---"
              if [ -f /tmp/dns-extract/all_records.json ]; then
                if jq empty /tmp/dns-extract/all_records.json 2>/dev/null; then
                  RECORD_COUNT=$(jq 'length' /tmp/dns-extract/all_records.json)
                  echo "Records: ${RECORD_COUNT}"

                  if [ "$RECORD_COUNT" -gt 0 ]; then
                    # Show record type breakdown
                    jq -r '[.[].type] | group_by(.) | map({type: .[0], count: length}) | .[] | .type + ": " + (.count | tostring)' \
                      /tmp/dns-extract/all_records.json
                    PASS=$((PASS + 1))
                    echo "DNS records: PASS"
                  else
                    echo "FAIL: all_records.json is empty!"
                    FAIL=$((FAIL + 1))
                  fi
                else
                  echo "FAIL: all_records.json is not valid JSON!"
                  FAIL=$((FAIL + 1))
                fi
              else
                echo "FAIL: all_records.json not found in archive!"
                FAIL=$((FAIL + 1))
              fi

              # Validate zone_settings.json
              echo ""
              echo "--- Validating zone settings ---"
              if [ -f /tmp/dns-extract/zone_settings.json ]; then
                if jq empty /tmp/dns-extract/zone_settings.json 2>/dev/null; then
                  ZONE_NAME=$(jq -r '.name // "unknown"' /tmp/dns-extract/zone_settings.json)
                  echo "Zone: ${ZONE_NAME}"
                  PASS=$((PASS + 1))
                  echo "Zone settings: PASS"
                else
                  echo "FAIL: zone_settings.json is not valid JSON!"
                  FAIL=$((FAIL + 1))
                fi
              else
                echo "FAIL: zone_settings.json not found in archive!"
                FAIL=$((FAIL + 1))
              fi

              # Validate BIND zone file
              echo ""
              echo "--- Validating BIND zone file ---"
              if [ -f /tmp/dns-extract/zone-export.txt ]; then
                LINE_COUNT=$(wc -l < /tmp/dns-extract/zone-export.txt)
                echo "Zone file: ${LINE_COUNT} lines"
                if [ "$LINE_COUNT" -gt 0 ]; then
                  PASS=$((PASS + 1))
                  echo "BIND zone file: PASS"
                else
                  echo "FAIL: zone-export.txt is empty!"
                  FAIL=$((FAIL + 1))
                fi
              else
                echo "FAIL: zone-export.txt not found in archive!"
                FAIL=$((FAIL + 1))
              fi

              # Diff record count against live Cloudflare (if token available)
              echo ""
              echo "--- Live comparison ---"
              LIVE_COUNT=0
              PAGE=1
              while true; do
                RESPONSE=$(curl -s -X GET \
                  "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?per_page=100&page=${PAGE}" \
                  -H "Authorization: Bearer ${CF_API_TOKEN}" \
                  -H "Content-Type: application/json")

                COUNT=$(echo "$RESPONSE" | jq '.result | length')
                if [ "$COUNT" -eq 0 ] 2>/dev/null; then
                  break
                fi
                LIVE_COUNT=$((LIVE_COUNT + COUNT))
                PAGE=$((PAGE + 1))
              done

              if [ "$LIVE_COUNT" -gt 0 ]; then
                DIFF=$((LIVE_COUNT - RECORD_COUNT))
                echo "Live records: ${LIVE_COUNT}, Backup records: ${RECORD_COUNT}, Drift: ${DIFF}"
                if [ "$DIFF" -lt 0 ]; then DIFF=$(( -DIFF )); fi
                if [ "$DIFF" -gt 5 ]; then
                  echo "WARNING: Record count drift > 5 â€” backup may be stale"
                else
                  PASS=$((PASS + 1))
                  echo "Live comparison: PASS"
                fi
              else
                echo "SKIP: Could not fetch live records (token may lack permission)"
              fi

              # Cleanup
              rm -rf /tmp/dns-extract "/tmp/${LATEST}"

              echo ""
              echo "=== Summary: ${PASS} passed, ${FAIL} failed ==="

              if [ "$FAIL" -gt 0 ]; then
                exit 1
              fi
            env:
            - name: CF_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: cloudflare-secrets
                  key: api-token
            - name: CF_ZONE_ID
              valueFrom:
                secretKeyRef:
                  name: cloudflare-secrets
                  key: zone-id
            - name: B2_BUCKET
              value: "Marmoset"
            - name: B2_ENDPOINT
              value: "https://s3.us-east-005.backblazeb2.com"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: velero-b2-credentials
                  key: aws_access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: velero-b2-credentials
                  key: aws_secret_access_key
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
