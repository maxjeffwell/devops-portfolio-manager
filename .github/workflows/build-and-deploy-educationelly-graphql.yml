name: Build and Deploy educationELLy-GraphQL

on:
  push:
    branches: [ main ]
    paths:
      - 'helm-charts/educationelly-graphql/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Version tag (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build-deploy:
    permissions:
      contents: write
      packages: write
    uses: ./.github/workflows/reusable-build-deploy.yml
    with:
      app-name: educationelly-graphql
      app-display-name: educationELLy-GraphQL
      helm-chart-path: helm-charts/educationelly-graphql
      source-repo: maxjeffwell/educationELLy-graphql-Docker
      source-repo-ref: master
      image-name-backend: maxjeffwell/educationelly-graphql-server
      image-name-frontend: maxjeffwell/educationelly-graphql-client
      backend-context: ./source/educationELLy-graphql-server
      frontend-context: ./source/educationELLy-graphql-client
      build-target: production
      checkout-submodules: true
      version: ${{ inputs.version || '' }}
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
