# GPU Operator Helm values override
# Fixes restart loops caused by leader election lease timeouts and aggressive probes
# on the overloaded control-plane node (vmi2951245)
#
# Apply with:
#   sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml helm upgrade gpu-operator nvidia/gpu-operator \
#     -n gpu-operator -f values-override.yaml
#
# After applying, re-run patch-operator-probes.sh to fix hardcoded operator probes.

# Preserve existing user values
driver:
  enabled: false
migManager:
  enabled: false
toolkit:
  enabled: true
devicePlugin:
  enabled: true
dcgmExporter:
  enabled: true
nodeStatusExporter:
  enabled: true

# Move operator controller to data node (vmi3115606) to avoid leader election
# lease timeouts caused by API server CPU pressure on vmi2951245
operator:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: role
                operator: In
                values:
                  - data
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 128Mi

# NFD master - move to data node and add explicit probe timeouts
node-feature-discovery:
  # Bump to v0.18.3 (latest patch) - no fix for nil pointer crash on shutdown
  # but includes arch support and kubectl-nfd plugin fix
  image:
    repository: registry.k8s.io/nfd/node-feature-discovery
    tag: v0.18.3
  master:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: role
                  operator: In
                  values:
                    - data
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
      periodSeconds: 20
      failureThreshold: 5
    readinessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 10
    resources:
      limits:
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 128Mi
  # NFD worker - fix aggressive probe timeouts causing 383+ restarts on control-plane node
  # Default: timeoutSeconds=1, failureThreshold=3 (liveness)
  # With control-plane CPU contention, /healthz regularly times out within 1s
  worker:
    livenessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 5
    readinessProbe:
      initialDelaySeconds: 5
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 10
  gc:
    livenessProbe:
      initialDelaySeconds: 10
      timeoutSeconds: 5
    readinessProbe:
      initialDelaySeconds: 5
      timeoutSeconds: 5
