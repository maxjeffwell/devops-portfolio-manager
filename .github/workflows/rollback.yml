name: Rollback Deployment (GitOps)

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application to rollback'
        required: true
        type: choice
        options:
          - intervalai
          - bookmarked
          - firebook
          - educationelly
          - educationelly-graphql
          - code-talk
          - podrick
      commits-back:
        description: 'Number of commits back to rollback (1 = previous version)'
        required: false
        default: '1'
        type: string

permissions:
  contents: write

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.application }}
    runs-on: ubuntu-latest
    env:
      APP: ${{ github.event.inputs.application }}
      COMMITS_BACK: ${{ github.event.inputs.commits-back }}
      TRIGGERED_BY: ${{ github.actor }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find previous image tag
        id: find-tag
        run: |
          VALUES_FILE="helm-charts/${APP}/values.yaml"

          echo "Looking for previous image tags in ${VALUES_FILE}..."

          # Get current tag
          CURRENT_TAG=$(grep -E "^\s+tag:" "${VALUES_FILE}" | head -1 | awk '{print $2}')
          echo "Current tag: ${CURRENT_TAG}"

          # Find the commit that changed the tag N commits ago
          PREVIOUS_TAG=$(git log -p --follow -S "tag:" -- "${VALUES_FILE}" | \
            grep -E "^\+\s+tag:" | \
            head -n $((COMMITS_BACK + 1)) | \
            tail -1 | \
            awk '{print $2}')

          if [ -z "${PREVIOUS_TAG}" ] || [ "${PREVIOUS_TAG}" == "${CURRENT_TAG}" ]; then
            # Fallback: get from git show
            COMMIT_HASH=$(git log --oneline -- "${VALUES_FILE}" | sed -n "$((COMMITS_BACK + 1))p" | awk '{print $1}')
            if [ -n "${COMMIT_HASH}" ]; then
              PREVIOUS_TAG=$(git show "${COMMIT_HASH}:${VALUES_FILE}" 2>/dev/null | grep -E "^\s+tag:" | head -1 | awk '{print $2}')
            fi
          fi

          if [ -z "${PREVIOUS_TAG}" ]; then
            echo "âŒ Could not find previous image tag"
            exit 1
          fi

          echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          echo "current-tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“‹ Rollback plan:"
          echo "   Current: ${CURRENT_TAG}"
          echo "   Target:  ${PREVIOUS_TAG}"

      - name: Update values.yaml
        env:
          PREVIOUS_TAG: ${{ steps.find-tag.outputs.previous-tag }}
        run: |
          VALUES_FILE="helm-charts/${APP}/values.yaml"

          echo "Updating ${VALUES_FILE} with tag: ${PREVIOUS_TAG}"
          sed -i "s|tag: .*|tag: ${PREVIOUS_TAG}|g" "${VALUES_FILE}"

          echo ""
          echo "Updated values.yaml:"
          grep -A1 "tag:" "${VALUES_FILE}"

      - name: Commit and push
        env:
          CURRENT_TAG: ${{ steps.find-tag.outputs.current-tag }}
          PREVIOUS_TAG: ${{ steps.find-tag.outputs.previous-tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "helm-charts/${APP}/values.yaml"
          git commit -m "Rollback ${APP} from ${CURRENT_TAG} to ${PREVIOUS_TAG}

          Triggered by: ${TRIGGERED_BY}
          Reason: Manual rollback via GitHub Actions"

          git push origin main

          echo ""
          echo "âœ… GitOps rollback committed!"
          echo "ArgoCD will automatically sync the rollback."

      - name: Rollback summary
        if: always()
        env:
          CURRENT_TAG: ${{ steps.find-tag.outputs.current-tag }}
          PREVIOUS_TAG: ${{ steps.find-tag.outputs.previous-tag }}
        run: |
          echo "==================================="
          echo "GitOps Rollback Summary"
          echo "==================================="
          echo "Application: ${APP}"
          echo "Previous tag: ${CURRENT_TAG}"
          echo "Rolled back to: ${PREVIOUS_TAG}"
          echo "Status: ${{ job.status }}"
          echo ""
          echo "ArgoCD will detect the change and sync automatically."
          echo "Monitor at: https://argocd.el-jefe.me"
