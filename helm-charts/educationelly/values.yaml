replicaCount: 1

# Use Recreate strategy to avoid resource pressure during deploys
strategy:
  type: Recreate

image:
  server:
    repository: maxjeffwell/educationelly-server
    tag: 20260211-014127-35e2fbd
    pullPolicy: Always
  client:
    repository: maxjeffwell/educationelly-client
    tag: 20260211-014127-35e2fbd
    pullPolicy: Always
service:
  server:
    type: ClusterIP
    port: 8080
    targetPort: 8080
    nodePort: 30007
  client:
    type: NodePort
    port: 80
    targetPort: 3000
    nodePort: 30008
resources:
  server:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 256Mi
  client:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 80
env:
  server:
    - name: NODE_ENV
      value: "production"
    - name: PORT
      value: "8080"
    - name: ALLOWED_ORIGINS
      value: "https://educationelly-k8s.el-jefe.me"
    - name: MONGODB_URI
      valueFrom:
        secretKeyRef:
          name: educationelly-secret
          key: MONGODB_URI
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: educationelly-secret
          key: JWT_SECRET
    # MongoDB Connection Pool Configuration
    - name: MONGODB_POOL_MIN_SIZE
      value: "10"
    - name: MONGODB_POOL_MAX_SIZE
      value: "50"
    - name: MONGODB_MAX_IDLE_TIME_MS
      value: "30000"
    - name: MONGODB_WAIT_QUEUE_TIMEOUT_MS
      value: "5000"
    - name: MONGODB_SERVER_SELECTION_TIMEOUT_MS
      value: "5000"
    # Cloudflare Cache Configuration
    - name: CLOUDFLARE_API_TOKEN
      valueFrom:
        secretKeyRef:
          name: cloudflare-secrets
          key: api-token
    - name: CLOUDFLARE_ZONE_ID
      valueFrom:
        secretKeyRef:
          name: cloudflare-secrets
          key: zone-id
    - name: PUBLIC_URL
      value: "https://educationelly-k8s.el-jefe.me"
    # Sentry error tracking
    - name: SENTRY_DSN
      valueFrom:
        secretKeyRef:
          name: educationelly-secret
          key: SENTRY_DSN
  client:
    # Sentry error tracking for client
    - name: REACT_APP_SENTRY_DSN
      valueFrom:
        secretKeyRef:
          name: educationelly-secret
          key: REACT_APP_SENTRY_DSN
    # REACT_APP_API_URL removed - client config.js defaults to /api in production
serviceAccount:
  create: false
podSecurityContext:
  fsGroup: 2000
securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: false
  runAsUser: 1001
# /health/ready returns 503 when MongoDB is disconnected, enabling auto-restart
livenessProbe:
  httpGet:
    path: /health/ready
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
readinessProbe:
  httpGet:
    path: /health/ready
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Client-specific probes (node server on port 3000)
livenessProbeClient:
  tcpSocket:
    port: 3000
  initialDelaySeconds: 10
  periodSeconds: 10
readinessProbeClient:
  tcpSocket:
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 5

# ⚠️ CRITICAL SECURITY WARNING ⚠️
# NEVER commit real secrets to Git repositories!
# Use one of these secure alternatives:
#
# Option 1: External Secrets Operator (Recommended for production)
# externalSecret:
#   enabled: true
#   backendType: gcpSecretsManager  # or awsSecretsManager, azureKeyVault
#   projectID: your-project-id
#   data:
#     - key: educationelly-mongodb-uri
#       name: MONGODB_URI
#     - key: educationelly-jwt-secret
#       name: JWT_SECRET
#
# Option 2: Sealed Secrets (GitOps-friendly)
# kubectl create secret generic educationelly-secret \
#   --from-literal=MONGODB_URI='your-uri' \
#   --from-literal=JWT_SECRET='your-secret' \
#   --dry-run=client -o yaml | \
#   kubeseal -o yaml > sealed-secret.yaml
#
# Option 3: Helm values override at deploy time (for development)
# helm install educationelly . --set secret.data.MONGODB_URI='...' --set secret.data.JWT_SECRET='...'
#
# Cloud Database Configuration
# IMPORTANT: Replace these placeholders before deployment
secret:
  # Secrets managed externally - do not recreate
  data:
    # Base64 encode your MongoDB Atlas connection string:
    # echo -n "mongodb+srv://user:pass@cluster.mongodb.net/educationelly" | base64
    MONGODB_URI: "REPLACE_WITH_BASE64_ENCODED_MONGODB_ATLAS_URI"

    # Base64 encode your JWT secret (use strong random string):
    # openssl rand -base64 32 | base64
    JWT_SECRET: "REPLACE_WITH_BASE64_ENCODED_JWT_SECRET"

# MongoDB Configuration
mongodb:
  # Backup configuration (mongodump to Backblaze B2)
  backup:
    enabled: true
    schedule: "5 3 * * *"
    b2Bucket: "Marmoset"
    b2Endpoint: "https://s3.us-east-005.backblazeb2.com"
    b2SecretName: "velero-b2-credentials"
    retentionDays: 30
  # Connection Pool Configuration
  # These settings prevent connection exhaustion under load
  pool:
    # Minimum number of connections to maintain
    minSize: 10
    # Maximum number of connections allowed
    maxSize: 50
    # Time (ms) before idle connections are closed
    maxIdleTimeMs: 30000
    # Timeout (ms) for waiting for available connection
    waitQueueTimeoutMs: 5000
    # Timeout (ms) for server selection
    serverSelectionTimeoutMs: 5000

# Ingress Configuration
ingress:
  enabled: true
  host: educationelly-k8s.el-jefe.me
  apiPaths:
    - /api
    - /health
    - /metrics
