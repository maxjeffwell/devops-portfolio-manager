# Code Talk Application External Secret
# Code Talk requires PostgreSQL, Redis, and JWT secret
# Prerequisites:
# 1. Create and apply a SecretStore (e.g., aws-secretstore.yaml)
# 2. Store secrets in external store:
#    - portfolio/code-talk/database-url
#    - portfolio/code-talk/redis-url
#    - portfolio/code-talk/jwt-secret
# 3. Apply this ExternalSecret: kubectl apply -f code-talk-externalsecret.yaml

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: code-talk-externalsecret
  namespace: default
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secretstore  # Change to your SecretStore name
    kind: SecretStore

  target:
    name: code-talk-secret
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: code-talk
      data:
        DATABASE_URL: "{{ .databaseUrl }}"
        REDIS_URL: "{{ .redisUrl }}"
        JWT_SECRET: "{{ .jwtSecret }}"

  data:
    - secretKey: databaseUrl
      remoteRef:
        key: portfolio/code-talk/database-url
    - secretKey: redisUrl
      remoteRef:
        key: portfolio/code-talk/redis-url
    - secretKey: jwtSecret
      remoteRef:
        key: portfolio/code-talk/jwt-secret
