apiVersion: batch/v1
kind: CronJob
metadata:
  name: doppler-secrets-restore-test
  labels:
    app: doppler-secrets-restore-test
spec:
  schedule: "15 7 1-7 * 0"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 172800
      template:
        metadata:
          labels:
            app: doppler-secrets-restore-test
            portfolio: "true"
        spec:
          restartPolicy: Never
          containers:
          - name: restore-test
            image: alpine:3.21
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache curl jq openssl aws-cli > /dev/null 2>&1

              echo "=== Doppler Secrets Restore Test ==="
              echo "Date: $(date)"
              PASS=0
              FAIL=0

              # Find latest Doppler backup in B2
              LATEST=$(aws s3 ls "s3://${B2_BUCKET}/doppler-backups/" \
                --endpoint-url="${B2_ENDPOINT}" | grep "doppler-secrets-" | sort | tail -1 | awk '{print $NF}')

              if [ -z "$LATEST" ]; then
                echo "ERROR: No Doppler secrets backup found in B2!"
                echo "=== Summary: 0 passed, 1 failed ==="
                exit 1
              fi

              echo "Found: ${LATEST}"

              # Check backup age (weekly backups should be < 8 days old)
              FILE_DATE=$(echo "$LATEST" | grep -oE '[0-9]{8}' | head -1)
              FILE_DATE_FMT=$(echo "$FILE_DATE" | sed 's/\(.\{4\}\)\(.\{2\}\)/\1-\2-/')
              TODAY_FMT=$(date +%Y-%m-%d)
              AGE_DAYS=$(( ($(date -d "$TODAY_FMT" +%s) - $(date -d "$FILE_DATE_FMT" +%s)) / 86400 ))
              echo "Backup age: ${AGE_DAYS} days"

              if [ "$AGE_DAYS" -gt 8 ]; then
                echo "FAIL: Backup is ${AGE_DAYS} days old (expected <8 for weekly schedule)"
                FAIL=$((FAIL + 1))
              else
                echo "Age check: OK"
                PASS=$((PASS + 1))
              fi

              # Download
              aws s3 cp "s3://${B2_BUCKET}/doppler-backups/${LATEST}" "/tmp/${LATEST}" \
                --endpoint-url="${B2_ENDPOINT}" > /dev/null

              SIZE=$(du -h "/tmp/${LATEST}" | cut -f1)
              echo "Downloaded: ${SIZE}"

              # Decrypt with the same passphrase used for backup
              echo ""
              echo "--- Testing decryption ---"
              if openssl enc -aes-256-cbc -d -salt -pbkdf2 -iter 100000 \
                -in "/tmp/${LATEST}" \
                -out /tmp/secrets-decrypted.json \
                -pass pass:"${ENCRYPTION_PASSPHRASE}" 2>/dev/null; then
                echo "Decryption: OK"
                PASS=$((PASS + 1))
              else
                echo "FAIL: Could not decrypt backup (wrong passphrase or corrupt file)"
                FAIL=$((FAIL + 1))
                rm -f "/tmp/${LATEST}" /tmp/secrets-decrypted.json
                echo ""
                echo "=== Summary: ${PASS} passed, ${FAIL} failed ==="
                exit 1
              fi

              # Validate JSON structure
              echo ""
              echo "--- Validating JSON ---"
              if jq empty /tmp/secrets-decrypted.json 2>/dev/null; then
                KEY_COUNT=$(jq 'keys | length' /tmp/secrets-decrypted.json)
                echo "Secret keys: ${KEY_COUNT}"

                if [ "$KEY_COUNT" -gt 0 ]; then
                  # Show key names only (not values!) for verification
                  echo "Sample keys:"
                  jq -r 'keys[:5][]' /tmp/secrets-decrypted.json | sed 's/^/  /'
                  if [ "$KEY_COUNT" -gt 5 ]; then
                    echo "  ... and $((KEY_COUNT - 5)) more"
                  fi
                  PASS=$((PASS + 1))
                  echo "JSON validation: PASS"
                else
                  echo "FAIL: Decrypted JSON has no keys!"
                  FAIL=$((FAIL + 1))
                fi
              else
                echo "FAIL: Decrypted output is not valid JSON!"
                FAIL=$((FAIL + 1))
              fi

              # Compare key count against live Doppler
              echo ""
              echo "--- Live comparison ---"
              LIVE_RESPONSE=$(curl -s -o /tmp/live-secrets.json -w "%{http_code}" \
                "https://api.doppler.com/v3/configs/config/secrets/download?format=json" \
                -H "authorization: Bearer ${DOPPLER_TOKEN}")

              if [ "$LIVE_RESPONSE" = "200" ]; then
                LIVE_COUNT=$(jq 'keys | length' /tmp/live-secrets.json)
                DIFF=$((LIVE_COUNT - KEY_COUNT))
                echo "Live keys: ${LIVE_COUNT}, Backup keys: ${KEY_COUNT}, Drift: ${DIFF}"
                if [ "$DIFF" -lt 0 ]; then DIFF=$(( -DIFF )); fi
                if [ "$DIFF" -gt 3 ]; then
                  echo "WARNING: Key count drift > 3 â€” secrets may have changed significantly"
                else
                  PASS=$((PASS + 1))
                  echo "Live comparison: PASS"
                fi
                rm -f /tmp/live-secrets.json
              else
                echo "SKIP: Could not fetch live secrets (HTTP ${LIVE_RESPONSE})"
              fi

              # Securely clean up decrypted secrets
              rm -f /tmp/secrets-decrypted.json "/tmp/${LATEST}"

              echo ""
              echo "=== Summary: ${PASS} passed, ${FAIL} failed ==="

              if [ "$FAIL" -gt 0 ]; then
                exit 1
              fi
            env:
            - name: DOPPLER_TOKEN
              valueFrom:
                secretKeyRef:
                  name: doppler-token-auth
                  key: dopplerToken
            - name: ENCRYPTION_PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: doppler-backup-encryption
                  key: passphrase
            - name: B2_BUCKET
              value: "Marmoset"
            - name: B2_ENDPOINT
              value: "https://s3.us-east-005.backblazeb2.com"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: velero-b2-credentials
                  key: aws_access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: velero-b2-credentials
                  key: aws_secret_access_key
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
