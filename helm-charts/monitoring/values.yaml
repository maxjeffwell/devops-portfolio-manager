# Custom Ingress Configuration (separate from kube-prometheus-stack ingress)
ingress:
  enabled: true
  grafanaHost: grafana.el-jefe.me
  grafanaService: prometheus-grafana
  grafanaPort: 80
  prometheusHost: prometheus.el-jefe.me
  prometheusService: prometheus-kube-prometheus-prometheus
  prometheusPort: 9090

# Kube-Prometheus-Stack Configuration
kube-prometheus-stack:
  # Prometheus Configuration
  prometheus:
    prometheusSpec:
      # Number of replicas
      replicas: 1
      # Retention period for metrics
      retention: 15d
      # Node selector - run on VPS to ensure network access to all targets
      nodeSelector:
        kubernetes.io/hostname: vmi2951245
      # Storage configuration
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      # Resource limits
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
      # Service monitors for scraping application metrics
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /$2
      hosts:
        - ""
      paths:
        - /prometheus(/|$)(.*)
      pathType: ImplementationSpecific

  # Grafana Configuration
  # ⚠️  SECURITY: Override adminPassword at deploy time!
  # helm install monitoring . --set kube-prometheus-stack.grafana.adminPassword="$(openssl rand -base64 24)"
  grafana:
    enabled: true
    adminPassword: "REPLACE_AT_DEPLOY_TIME"

    # Grafana ingress configuration
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /$2
      hosts:
        - ""
      path: /grafana(/|$)(.*)
      pathType: ImplementationSpecific

    # Configure Grafana to work with sub-path
    grafana.ini:
      server:
        root_url: "%(protocol)s://%(domain)s/grafana"
        serve_from_sub_path: true

    # Pre-configured datasources
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://monitoring-kube-prometheus-prometheus:9090
            access: proxy
            isDefault: true

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Default dashboards
    defaultDashboardsEnabled: true
    defaultDashboardsTimezone: UTC

  # AlertManager Configuration
  alertmanager:
    enabled: true
    config:
      global:
        resolve_timeout: 5m
      inhibit_rules:
        - equal: ['namespace', 'alertname']
          source_matchers:
            - severity = critical
          target_matchers:
            - severity =~ warning|info
        - equal: ['namespace', 'alertname']
          source_matchers:
            - severity = warning
          target_matchers:
            - severity = info
        - equal: ['namespace']
          source_matchers:
            - alertname = InfoInhibitor
          target_matchers:
            - severity = info
        - target_matchers:
            - alertname = InfoInhibitor
      receivers:
        - name: 'null'
      route:
        group_by: ['namespace']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'null'
        routes:
          # Silence Watchdog (always-firing health check)
          - matchers:
              - alertname = "Watchdog"
            receiver: 'null'
          # Silence GPU operator DaemonSet false-positives only
          - matchers:
              - namespace = "gpu-operator"
              - alertname =~ "KubeDaemonSetMisScheduled|KubeDaemonSetRolloutStuck"
            receiver: 'null'
          # Silence k3s control plane alerts (bundled into k3s binary)
          - matchers:
              - alertname =~ "KubeControllerManagerDown|KubeSchedulerDown|KubeProxyDown"
            receiver: 'null'
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /$2
      hosts:
        - ""
      paths:
        - /alertmanager(/|$)(.*)
      pathType: ImplementationSpecific

  # Node Exporter - collect node-level metrics
  nodeExporter:
    enabled: true

  # Kube State Metrics - collect Kubernetes object metrics
  kubeStateMetrics:
    enabled: true

  # Prometheus Operator
  prometheusOperator:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi
